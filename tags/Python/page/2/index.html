<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Tag: Python | Brian&#39;s Blog</title>
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="Meow">
<meta property="og:type" content="website">
<meta property="og:title" content="Brian's Blog">
<meta property="og:url" content="https://blog.ohai.ca/tags/Python/page/2/index.html">
<meta property="og:site_name" content="Brian's Blog">
<meta property="og:description" content="Meow">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Brian's Blog">
<meta name="twitter:description" content="Meow">
  
    <link rel="alternative" href="/atom.xml" title="Brian&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="../../../../css/style.css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div class="mobile-nav-panel">
	<i class="icon-reorder icon-large"></i>
</div>
<header id="header">
	<h1 class="blog-title">
		<a href="/">Brian&#39;s Blog</a>
	</h1>
	<nav class="nav">
		<ul>
			<li><a href="/">Home</a></li><li><a href="/archives">Archives</a></li>
			<li><a id="nav-search-btn" class="nav-icon" title="Search"></a></li>
			<li><a href="/atom.xml" id="nav-rss-link" class="nav-icon" title="RSS Feed"></a></li>
		</ul>
	</nav>
	<div id="search-form-wrap">
		<form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.ohai.ca"></form>
	</div>
</header>
    <div id="main">
      
  
    <article id="post-Writing-a-flake8-plugin" class="post">
	<footer class="entry-meta-header">
		<span class="meta-elements date">
			<a href="/2019/Writing-a-flake8-plugin/" class="article-date">
  <time datetime="2019-04-11T15:45:33.000Z" itemprop="datePublished">2019-04-11</time>
</a>
		</span>
		<span class="meta-elements author">Brian</span>
		<div class="commentscount">
			
		</div>
	</footer>
	
	<header class="entry-header">
		
  
    <h1 itemprop="name" class="entry-title">
      <a class="article-title" href="/2019/Writing-a-flake8-plugin/">Writing a Flake8 Plugin</a>
    </h1>
  

	</header>
	<div class="entry-content">
		
    	<p>There appears to be no good way to run a flake8 plugin that is not its own package. For example, if you have a project and you want to include a custom flake8 inside it, you will have to <em>install your project</em> to <a href="https://flake8.pycqa.org/en/latest/plugin-development/registering-plugins.html" target="_blank" rel="external">register</a> it:</p>
<pre><code># Me literally installing myself so flake8 can find it 
from setuptools import setup


setup(
    name=&apos;my_project&apos;,
    author=&apos;Me&apos;,
    license=&apos;Proprietary&apos;,
    classifiers=[
        &apos;License :: Other/Proprietary License&apos;,
    ],
    packages=[
        &apos;my_static_checker&apos;,
    ],
    entry_points={
        &apos;flake8.extension&apos;: [
            &apos;R2 = my_static_checker.main:Checker&apos;,
        ],
    },
)
</code></pre><p>As for what <code>Checker</code> checking, it is largely up to you, as long as the class contains a <code>run</code> method that yields four things:</p>
<pre><code>import ast

class Checker:
    name = &apos;my_static_checker&apos;
    version = &apos;0.1&apos;

    def __init__(self, tree, filename):
        self.tree = tree
        self.filename = filename

    def run(self):
        # Use whatever tool you like to find these, but ast is imported
        errors = (line, column, message)
        for line, column, message in errors:
            yield line, column, message, type(self)
</code></pre>
    
	</div>
	<footer class="entry-footer">
		<div class="entry-meta-footer">
			<span class="category">
				
			</span>
			<span class="tags">
				
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../">Python</a></li></ul>

			</span>
		</div>
	</footer>
	
</article>


	<hr class="article-devider">




  
    <article id="post-Python-terminal-recipes" class="post">
	<footer class="entry-meta-header">
		<span class="meta-elements date">
			<a href="/2019/Python-terminal-recipes/" class="article-date">
  <time datetime="2019-02-08T21:03:48.000Z" itemprop="datePublished">2019-02-08</time>
</a>
		</span>
		<span class="meta-elements author">Brian</span>
		<div class="commentscount">
			
		</div>
	</footer>
	
	<header class="entry-header">
		
  
    <h1 itemprop="name" class="entry-title">
      <a class="article-title" href="/2019/Python-terminal-recipes/">Python Terminal Recipes</a>
    </h1>
  

	</header>
	<div class="entry-content">
		
    	<p>A lot of these can be replaced by a library like pandas, but sometimes you simply don’t have access to pandas…</p>
<h2 id="Turn-list-of-lists-into-a-copy-paste-CSV-file"><a href="#Turn-list-of-lists-into-a-copy-paste-CSV-file" class="headerlink" title="Turn list of lists into a copy-paste CSV file"></a>Turn list of lists into a copy-paste CSV file</h2><p>Do people ask you to “export” things from the database a lot, but never the same thing more than once?<br>Turn your Django or SQLAlchemy querysets, however complicated or mixed with logic, into a “CSV file” without installing additional libraries.</p>
<p>Note: if you give this function a list of dicts (which I did not say it handles), the columns will come out in whichever order it feels like.</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io, csv</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"></span><br><span class="line">def csvise(queryset, field_names=<span class="type">None</span>):</span><br><span class="line">    <span class="literal">result</span> = io.<span class="type">StringIO</span>()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> queryset:</span><br><span class="line">        <span class="keyword">return</span> ''</span><br><span class="line">    first_obj = queryset[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> isinstance(first_obj, list):</span><br><span class="line">        writer = csv.writer(<span class="literal">result</span>)</span><br><span class="line">    <span class="keyword">elif</span> isinstance(first_obj, dict):</span><br><span class="line">        writer = csv.<span class="type">DictWriter</span>(</span><br><span class="line">            <span class="literal">result</span>,</span><br><span class="line">            fieldnames=field_names <span class="keyword">or</span> queryset[<span class="number">0</span>].keys())</span><br><span class="line">        writer.writeheader()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> <span class="type">TypeError</span>('<span class="type">Things</span> <span class="keyword">in</span> queryset must be list <span class="keyword">or</span> dict!')</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> queryset:</span><br><span class="line">        writer.writerow(row)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">result</span>.getvalue()</span><br></pre></td></tr></table></figure>
<h2 id="Turn-a-CSV-file-string-into-a-list-of-dicts"><a href="#Turn-a-CSV-file-string-into-a-list-of-dicts" class="headerlink" title="Turn a CSV file string into a list of dicts"></a>Turn a CSV file string into a list of dicts</h2><p>Sometimes you want to get objects out of a string too.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io, csv</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dictise</span><span class="params">(csv_string)</span>:</span></span><br><span class="line">    csv_string = csv_string.strip()</span><br><span class="line">    reader_list = csv.DictReader(io.StringIO(csv_string))</span><br><span class="line">    <span class="keyword">return</span> [dict(row) <span class="keyword">for</span> row <span class="keyword">in</span> reader_list]</span><br></pre></td></tr></table></figure>
<h2 id="Turn-an-HTML-table-into-an-array-of-arrays"><a href="#Turn-an-HTML-table-into-an-array-of-arrays" class="headerlink" title="Turn an HTML table into an array of arrays"></a>Turn an HTML table into an array of arrays</h2><p>No recipes yet, <a href="https://stackoverflow.com/questions/2870667/how-to-convert-an-html-table-to-an-array-in-python" target="_blank" rel="external">without the use of third-party libraries.</a> But for some reason you have Pandas (which this post assumed you haven’t):</p>
<figure class="highlight capnproto"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">pd.read_html(content)  <span class="comment"># That's it</span></span><br></pre></td></tr></table></figure>
<h2 id="Sort-a-file-any-way-you-want"><a href="#Sort-a-file-any-way-you-want" class="headerlink" title="Sort a file any way you want"></a>Sort a file any way you want</h2><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">from</span> __future__ import print_function</span><br><span class="line"></span><br><span class="line">def sort_file_lines(<span class="built_in">file</span>, key=lambda x: x):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="built_in">file</span>, <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">lines</span> = f.readlines()</span><br><span class="line">        <span class="keyword">lines</span>.<span class="built_in">sort</span>(key=key)</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">line</span> <span class="keyword">in</span> <span class="keyword">lines</span>:</span><br><span class="line">        print(<span class="built_in">line</span>, <span class="keyword">end</span>=<span class="string">''</span>)</span><br></pre></td></tr></table></figure>
<p>You can then use this function with a sort function, like so: (this is a function that extracts test times from console output.)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_speed</span><span class="params">(line)</span>:</span></span><br><span class="line">    reg = re.search(<span class="string">r'OK \((\d+\.\d+)s\)'</span>, line)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> reg:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    runtime_str = reg.group(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> float(runtime_str)</span><br><span class="line"></span><br><span class="line">sort_file_lines(<span class="string">'blablabla.txt'</span>, test_speed)</span><br></pre></td></tr></table></figure>
<h2 id="Split-text-every-n-newlines"><a href="#Split-text-every-n-newlines" class="headerlink" title="Split text every n newlines"></a>Split text every n newlines</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def split_n_lines(text, *, n=<span class="number">1</span>):</span><br><span class="line">    assert n &gt;= <span class="number">1</span></span><br><span class="line">    <span class="keyword">buffer</span> = []</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">line</span> in text.<span class="keyword">split</span>(<span class="string">'\n'</span>):</span><br><span class="line">        <span class="keyword">buffer</span>.<span class="keyword">append</span>(<span class="built_in">line</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(<span class="keyword">buffer</span>) &gt;= n:</span><br><span class="line">            yield <span class="string">'\n'</span>.<span class="keyword">join</span>(<span class="keyword">buffer</span>)</span><br><span class="line">            <span class="keyword">buffer</span> = []</span><br></pre></td></tr></table></figure>
<h2 id="Get-a-rough-count-on-a-django-postgres-table"><a href="#Get-a-rough-count-on-a-django-postgres-table" class="headerlink" title="Get a rough count on a django-postgres table"></a>Get a rough count on a django-postgres table</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db import connection</span><br><span class="line"></span><br><span class="line">def rough_count(table_name):</span><br><span class="line">    with connection.cursor() as cursor:</span><br><span class="line">        cursor.execute(<span class="string">"SELECT reltuples FROM pg_class WHERE relname = %s"</span>,</span><br><span class="line">                        [table_name])</span><br><span class="line">        record = cursor.fetchone()</span><br><span class="line">    <span class="keyword">if</span> record:</span><br><span class="line">        return int(record[0])</span><br><span class="line">    return 0</span><br></pre></td></tr></table></figure>
<h2 id="Get-someone’s-Django-token"><a href="#Get-someone’s-Django-token" class="headerlink" title="Get someone’s (Django) token"></a>Get someone’s (Django) token</h2><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def get_token(email):</span><br><span class="line">    <span class="keyword">if</span> isinstance(email, <span class="built_in">str</span>):</span><br><span class="line">        <span class="keyword">return</span> Token.objects.<span class="built_in">filter</span>(user__email=email).first().<span class="built_in">key</span></span><br><span class="line">    <span class="keyword">return</span> Token.objects.<span class="built_in">filter</span>(user=email).first().<span class="built_in">key</span></span><br></pre></td></tr></table></figure>
<h2 id="Extract-something-from-a-page"><a href="#Extract-something-from-a-page" class="headerlink" title="Extract something from a page"></a>Extract something from a page</h2><p>PyQuery is like a cheater’s version of BeautifulSoup.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract</span><span class="params">(url, selector)</span>:</span></span><br><span class="line">    <span class="keyword">import</span> requests</span><br><span class="line">    <span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line">    resp = requests.get(url)</span><br><span class="line">    <span class="keyword">return</span> pq(resp.content).find(selector).text()</span><br></pre></td></tr></table></figure>
<h2 id="Track-performance-of-a-piece-of-code"><a href="#Track-performance-of-a-piece-of-code" class="headerlink" title="Track performance of a piece of code"></a>Track performance of a piece of code</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextlib.contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tracker</span><span class="params">()</span>:</span></span><br><span class="line">    start = datetime.now()</span><br><span class="line">    <span class="keyword">yield</span></span><br><span class="line">    finish = datetime.now()</span><br><span class="line">    print(<span class="string">'%f seconds'</span> % (finish - start).total_seconds())</span><br></pre></td></tr></table></figure>
<h2 id="Timestamps-broken-down-by-weekday-and-hour-of-day"><a href="#Timestamps-broken-down-by-weekday-and-hour-of-day" class="headerlink" title="Timestamps, broken down by weekday and hour of day"></a>Timestamps, broken down by weekday and hour of day</h2><p>Requires the <code>csvise</code> recipe above, and the <code>arrow</code> package.</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import arrow</span><br><span class="line">def time_grid(date_times):</span><br><span class="line">    weekdays = [<span class="string">'Monday'</span>, <span class="string">'Tuesday'</span>, <span class="string">'Wednesday'</span>, <span class="string">'Thursday'</span>,</span><br><span class="line">                <span class="string">'Friday'</span>, <span class="string">'Saturday'</span>, <span class="string">'Sunday'</span>]</span><br><span class="line">    buckets = []</span><br><span class="line">    buckets.<span class="keyword">append</span>([<span class="string">'Hour'</span>] + <span class="keyword">list</span>(<span class="built_in">range</span>(<span class="number">24</span>)))</span><br><span class="line">    <span class="keyword">for</span> weekday in <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        buckets.<span class="keyword">append</span>([weekdays[weekday]] + [<span class="number">0</span>] * <span class="number">24</span>)            </span><br><span class="line">    <span class="keyword">for</span> date_time in date_time<span class="variable">s:</span></span><br><span class="line">        date_time = arrow.<span class="built_in">get</span>(date_time).<span class="keyword">to</span>(<span class="string">'local'</span>)</span><br><span class="line">        buckets[date_time.isoweekday()][date_time.hour + <span class="number">1</span>] += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> csvise(buckets)</span><br></pre></td></tr></table></figure>
<h2 id="Timestamps-broken-down-by-day-and-hour-of-day"><a href="#Timestamps-broken-down-by-day-and-hour-of-day" class="headerlink" title="Timestamps, broken down by day and hour of day"></a>Timestamps, broken down by day and hour of day</h2><p>Requires the <code>csvise</code> recipe above, and the <code>arrow</code> package.</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">def time_grid(date_times):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> date_times:</span><br><span class="line">        <span class="literal">return</span> <span class="string">''</span></span><br><span class="line">    date_times = [arrow.<span class="built_in">get</span>(date_time).<span class="built_in">to</span>(<span class="string">'local'</span>)</span><br><span class="line">                  <span class="keyword">for</span> date_time <span class="keyword">in</span> date_times]</span><br><span class="line">    date_times.<span class="built_in">sort</span>()</span><br><span class="line">    start_date, end_date = date_times[<span class="number">0</span>].<span class="built_in">date</span>(), date_times[<span class="number">-1</span>].<span class="built_in">date</span>()</span><br><span class="line">    buckets = []</span><br><span class="line">    buckets.append([<span class="string">'Hour'</span>] + list(range(<span class="number">24</span>)))</span><br><span class="line">    <span class="built_in">date</span> = start_date</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">date</span> &lt; end_date:</span><br><span class="line">        buckets.append([<span class="built_in">date</span>] + [<span class="number">0</span>] * <span class="number">24</span>)</span><br><span class="line">        <span class="built_in">date</span> = <span class="built_in">date</span> + timedelta(days=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> idx, row <span class="keyword">in</span> enumerate(buckets):</span><br><span class="line">        <span class="keyword">if</span> idx == <span class="number">0</span>:  <span class="comment"># Header</span></span><br><span class="line">            continue</span><br><span class="line">        <span class="built_in">date</span> = row[<span class="number">0</span>]</span><br><span class="line">        date_times_on_this_date = [x <span class="keyword">for</span> x <span class="keyword">in</span> date_times</span><br><span class="line">                                   <span class="keyword">if</span> x.<span class="built_in">date</span>() == <span class="built_in">date</span>]</span><br><span class="line">        <span class="keyword">for</span> hour <span class="keyword">in</span> range(<span class="number">24</span>):</span><br><span class="line">            date_times_on_this_hour = [</span><br><span class="line">                x <span class="keyword">for</span> x <span class="keyword">in</span> date_times_on_this_date</span><br><span class="line">                <span class="keyword">if</span> x.hour == hour]</span><br><span class="line">            row[hour + <span class="number">1</span>] = <span class="built_in">len</span>(date_times_on_this_hour)</span><br><span class="line">    <span class="literal">return</span> csvise(buckets)</span><br></pre></td></tr></table></figure>

    
	</div>
	<footer class="entry-footer">
		<div class="entry-meta-footer">
			<span class="category">
				
			</span>
			<span class="tags">
				
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../">Python</a></li></ul>

			</span>
		</div>
	</footer>
	
</article>


	<hr class="article-devider">




  
    <article id="post-Setting-up-mypy" class="post">
	<footer class="entry-meta-header">
		<span class="meta-elements date">
			<a href="/2018/Setting-up-mypy/" class="article-date">
  <time datetime="2018-09-21T15:25:56.000Z" itemprop="datePublished">2018-09-21</time>
</a>
		</span>
		<span class="meta-elements author">Brian</span>
		<div class="commentscount">
			
		</div>
	</footer>
	
	<header class="entry-header">
		
  
    <h1 itemprop="name" class="entry-title">
      <a class="article-title" href="/2018/Setting-up-mypy/">Setting Up Mypy</a>
    </h1>
  

	</header>
	<div class="entry-content">
		
    	<p><a href="http://mypy-lang.org/" target="_blank" rel="external">mypy</a> is a static type checker for python.</p>
<p>Installing mypy is simple enough:</p>
<pre><code>pip install mypy
</code></pre><p>But running it, hmm…</p>
<pre><code>$ mypy .
manage.py:11: error: No library stub file for module &apos;django.core.management&apos;
foo/wsgi.py:17: error: No library stub file for module &apos;django.core.wsgi&apos;
foo/urls.py:5: error: Cannot find module named &apos;djangojs.views&apos;
foo/urls.py:5: error: Cannot find module named &apos;djangojs&apos;
foo/urls.py:6: error: No library stub file for module &apos;django.conf&apos;
foo/urls.py:7: error: No library stub file for module &apos;django.conf.urls&apos;
foo/urls.py:8: error: No library stub file for module &apos;django.contrib&apos;
foo/urls.py:9: error: No library stub file for module &apos;django.views.generic.foo&apos;
...
(Goes on for a hundred thousand lines)
</code></pre><p>So I did what <a href="https://github.com/python/mypy/issues/3905#issuecomment-326539680" target="_blank" rel="external">everyone else did</a> and added <code>--ignore-missing-imports</code> to the command line:</p>
<pre><code>$ mypy . --ignore-missing-imports
foo/admin.py:187: error: &quot;Callable[[Any, Any, Any], Any]&quot; has no attribute &quot;short_description&quot;
foo/admin.py:199: error: &quot;Callable[[Any, Any, Any], Any]&quot; has no attribute &quot;short_description&quot;
foo/admin.py:255: error: &quot;Callable[[Any, Any], Any]&quot; has no attribute &quot;short_description&quot;
foo/admin.py:256: error: &quot;Callable[[Any, Any], Any]&quot; has no attribute &quot;admin_order_field&quot;
foo/admin.py:270: error: &quot;Callable[[Any, Any], Any]&quot; has no attribute &quot;short_description&quot;
foo/admin.py:271: error: &quot;Callable[[Any, Any], Any]&quot; has no attribute &quot;admin_order_field&quot;
foo/admin.py:285: error: &quot;Callable[[Any, Any], Any]&quot; has no attribute &quot;short_description&quot;
foo/admin.py:286: error: &quot;Callable[[Any, Any], Any]&quot; has no attribute &quot;allow_tags&quot;
</code></pre><p>Still thousands of errors!<br>It turns out <a href="https://github.com/python/mypy/issues/708" target="_blank" rel="external">every Django app that writes custom admins is affected by this check</a>. I guess I will need to <a href="https://www.python.org/dev/peps/pep-0484/#type-comments" target="_blank" rel="external">‘# type: ignore’</a> them all or try some stub, like <a href="https://github.com/machinalis/mypy-django" target="_blank" rel="external">mypy-django</a>.</p>

    
	</div>
	<footer class="entry-footer">
		<div class="entry-meta-footer">
			<span class="category">
				
			</span>
			<span class="tags">
				
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../QA/">QA</a></li></ul>

			</span>
		</div>
	</footer>
	
</article>


	<hr class="article-devider">




  
    <article id="post-How-to-reverse-a-list" class="post">
	<footer class="entry-meta-header">
		<span class="meta-elements date">
			<a href="/2017/How-to-reverse-a-list/" class="article-date">
  <time datetime="2017-04-17T15:17:34.000Z" itemprop="datePublished">2017-04-17</time>
</a>
		</span>
		<span class="meta-elements author">Brian</span>
		<div class="commentscount">
			
		</div>
	</footer>
	
	<header class="entry-header">
		
  
    <h1 itemprop="name" class="entry-title">
      <a class="article-title" href="/2017/How-to-reverse-a-list/">How to Reverse a List</a>
    </h1>
  

	</header>
	<div class="entry-content">
		
    	<blockquote>
<p>There should be one– and preferably only one –obvious way to do it</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; sorted([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>], reverse=True)</span><br><span class="line">[<span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; sorted([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]).reverse()  <span class="comment"># In place</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; reversed(sorted([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]))</span><br><span class="line">&lt;listreverseiterator object at <span class="number">0x7f5c5897b690</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; sorted([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])[<span class="symbol">:</span><span class="symbol">:-</span><span class="number">1</span>]</span><br><span class="line">[<span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; (lambda <span class="symbol">a:</span> a.sort() or a.reverse() or a)([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line">[<span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<p>Dammit python.</p>

    
	</div>
	<footer class="entry-footer">
		<div class="entry-meta-footer">
			<span class="category">
				
			</span>
			<span class="tags">
				
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../">Python</a></li></ul>

			</span>
		</div>
	</footer>
	
</article>


	<hr class="article-devider">




  
    <article id="post-Resetting-django-migrations" class="post">
	<footer class="entry-meta-header">
		<span class="meta-elements date">
			<a href="/2017/Resetting-django-migrations/" class="article-date">
  <time datetime="2017-03-23T02:16:10.000Z" itemprop="datePublished">2017-03-22</time>
</a>
		</span>
		<span class="meta-elements author">Brian</span>
		<div class="commentscount">
			
		</div>
	</footer>
	
	<header class="entry-header">
		
  
    <h1 itemprop="name" class="entry-title">
      <a class="article-title" href="/2017/Resetting-django-migrations/">Resetting Django Migrations</a>
    </h1>
  

	</header>
	<div class="entry-content">
		
    	<p>This is specifically meant for large web projects. For smaller, ordinary Django projects, see <code>manage.py squashmigrations</code>. For SQLAlchemy projects, do your own research.</p>
<h1 id="Mechanism"><a href="#Mechanism" class="headerlink" title="Mechanism"></a>Mechanism</h1><p>Django 1.7+ stores migration information in a django_migrations table. The contents look something like</p>
<pre><code>web=# select * from django_migrations;
id   |       app       |                      name                      |            applied            
-----+-----------------+------------------------------------------------+-------------------------------
12   | account         | 0002_email_max_length                          | 2017-03-21 14:16:17.046209-04
14   | admin           | 0002_logentry_remove_auto_add                  | 2017-03-21 14:16:17.098368-04
4    | auth            | 0002_alter_permission_name_max_length          | 2017-03-21 14:16:16.82983-04
788  | auth            | 0002_auto_...                                  | 2017-03-21 15:22:45.40872-04
573  | auth            | 0002_...                                       | 2017-03-21 15:06:12.735458-04
31   | authtoken       | 0002_auto_...                                  | 2017-03-21 14:16:19.556177-04
</code></pre><p>Running <code>./manage.py</code> migrate inserts new entries into the table. Conversely, running ./manage.py migrate app {latest_version - n} removes entries from the table.</p>
<h1 id="manage-py-squashmigrations"><a href="#manage-py-squashmigrations" class="headerlink" title="./manage.py squashmigrations"></a>./manage.py squashmigrations</h1><p>This command takes in a range of migrations from a specific app, combines the operations inside these migrations, and outputs one large migration with a replaces = [migration1, migration2, …] inside. This allows the list of migrations to be replaced by a larger one. Unless operations are cancelled out in migrations 1 to n, squashing migrations does not necessarily speed up the process.</p>
<p>From a series of experiments performed on a large web project, since squashmigrations operates on one app at a time, it does not appear to be effective on projects with many cross-app foreign keys, and unsquashable data migrations in between.</p>
<h1 id="Manually-clearing-migration-history"><a href="#Manually-clearing-migration-history" class="headerlink" title="Manually clearing migration history"></a>Manually clearing migration history</h1><p>There are many questions online about resetting migrations, showing perhaps a need for large projects to reset migrations eventually.</p>
<p>Their procedures are usually as follows:</p>
<ol>
<li>Delete all existing migrations</li>
<li>Fake migrations backward</li>
<li>Create new migrations</li>
<li>Fake migrations forward</li>
</ol>
<h2 id="Make-sure-current-database-state-is-consistent"><a href="#Make-sure-current-database-state-is-consistent" class="headerlink" title="Make sure current database state is consistent"></a>Make sure current database state is consistent</h2><pre><code>./manage.py showmigrations
</code></pre><p>The above command should display a list with all migrations applied.</p>
<h2 id="Fake-migrations-backward"><a href="#Fake-migrations-backward" class="headerlink" title="Fake migrations backward*"></a>Fake migrations backward*</h2><pre><code>./manage.py migrate --fake APP_NAME1 zero
./manage.py migrate --fake APP_NAME3 zero
...
</code></pre><p>This fools Django into believing that the database is fresh. Double check all project apps have no migrations applied, and all third-party apps have all migrations applied, by running ./manage.py showmigrations again.</p>
<p>*This step might be completely necessary, but it should be done to be safe. It is also possible to replace these commands with a more intrusive <code>DELETE FROM django_migrations WHERE app IN (&#39;APP_NAME1&#39;, &#39;APP_NAME2&#39;, ...);</code></p>
<h2 id="Delete-all-existing-migrations"><a href="#Delete-all-existing-migrations" class="headerlink" title="Delete all existing migrations"></a>Delete all existing migrations</h2><p>On a developer machine, delete all migrations in your “migrations” folders that are not <code>__init__.py</code>.</p>
<pre><code>find . -path &quot;*/migrations/*.py&quot; -not -name &quot;__init__.py&quot; -delete
</code></pre><h2 id="Create-new-migrations"><a href="#Create-new-migrations" class="headerlink" title="Create new migrations"></a>Create new migrations</h2><p>Recreate all “effectively missing” migrations by running <code>./manage.py makemigrations</code>.</p>
<p>If this step fails, the schema is too complex to be created in the first place. Consult an elder.</p>
<p>Ensure the new migrations are sane.</p>
<h2 id="Create-data-migrations"><a href="#Create-data-migrations" class="headerlink" title="Create data migrations"></a>Create data migrations</h2><p>Manually (and intelligently), port the data migrations in old migrations to new empty migrations on top of the new auto migrations. Some can be simplified; some are no longer necessary.</p>
<h2 id="Test-your-changes"><a href="#Test-your-changes" class="headerlink" title="Test your changes"></a>Test your changes</h2><p>You now have a new set of auto migrations generated from the schema, and a ported list of data migrations that will be run after the schema is created.</p>
<p>Recreate your database, running all new migrations. The website should run as expected. Tests should pass as expected.</p>
<h1 id="Applying-changes-on-production-other-machines"><a href="#Applying-changes-on-production-other-machines" class="headerlink" title="Applying changes on production / other machines"></a>Applying changes on production / other machines</h1><p>All existing instances of the project must have the latest migrations from develop applied.</p>
<p>Their procedures are usually as follows:</p>
<ol>
<li>Stay on old develop / master</li>
<li>Fake migrations backward</li>
<li>Switch to new develop / master</li>
<li>Fake migrations forward</li>
</ol>
<p>Faking migrations backward while on the old develop / master removes all records of them being applied.</p>
<p>Faking migrations forward while on the new develop / master pretends the new migrations are equivalent to the old ones.</p>
<p>After the operation, the Django project will not be aware of the old migrations. The transition is complete.</p>

    
	</div>
	<footer class="entry-footer">
		<div class="entry-meta-footer">
			<span class="category">
				
			</span>
			<span class="tags">
				
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../">Python</a></li></ul>

			</span>
		</div>
	</footer>
	
</article>


	<hr class="article-devider">




  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="../../">&laquo; Prev</a><a class="page-number" href="../../">1</a><span class="page-number current">2</span><a class="page-number" href="../3/">3</a><a class="page-number" href="../4/">4</a><a class="extend next" rel="next" href="../3/">Next &raquo;</a>
    </nav>
  

    </div>
    <div class="mb-search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:blog.ohai.ca">
  </form>
</div>
<footer id="footer">
	<h1 class="footer-blog-title">
		<a href="/">Brian&#39;s Blog</a>
	</h1>
	<span class="copyright">
		&copy; 2019 Brian<br>
		Modify from <a href="http://sanographix.github.io/tumblr/apollo/" target="_blank">Apollo</a> theme, designed by <a href="http://www.sanographix.net/" target="_blank">SANOGRAPHIX.NET</a><br>
		Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
	</span>
</footer>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>



<script src="../../../../js/script.js"></script>
  </div>

  <script type="text/javascript">
    //<![CDATA[
    var sc_project=4446854;
    var sc_invisible=0;
    var sc_security="74785e80";
    var scJsHost = (("https:" == document.location.protocol) ?
    "https://secure." : "http://www.");
    document.write(
      "<sc"+"ript type='text/javascript' src='" +
      scJsHost +
      "statcounter.com/counter/counter_xhtml.js'></" +
      "script>"
    );
    //]]>
  </script>
  <noscript>
    <img style="display: none"
         src="http://c.statcounter.com/4446854/0/74785e80/0/" />
  </noscript><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>
