<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Archives | Brian&#39;s Blog</title>
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="Meow">
<meta property="og:type" content="website">
<meta property="og:title" content="Brian's Blog">
<meta property="og:url" content="https://blog.ohai.ca/archives/page/2/index.html">
<meta property="og:site_name" content="Brian's Blog">
<meta property="og:description" content="Meow">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Brian's Blog">
<meta name="twitter:description" content="Meow">
  
    <link rel="alternative" href="/atom.xml" title="Brian&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="../../../css/style.css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div class="mobile-nav-panel">
	<i class="icon-reorder icon-large"></i>
</div>
<header id="header">
	<h1 class="blog-title">
		<a href="/">Brian&#39;s Blog</a>
	</h1>
	<nav class="nav">
		<ul>
			<li><a href="/">Home</a></li><li><a href="/archives">Archives</a></li>
			<li><a id="nav-search-btn" class="nav-icon" title="Search"></a></li>
			<li><a href="/atom.xml" id="nav-rss-link" class="nav-icon" title="RSS Feed"></a></li>
		</ul>
	</nav>
	<div id="search-form-wrap">
		<form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.ohai.ca"></form>
	</div>
</header>
    <div id="main">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/AWS/">AWS</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Access/">Access</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Accessibility/">Accessibility</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Android/">Android</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Apple/">Apple</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Business/">Business</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Career/">Career</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Cars/">Cars</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Chemistry/">Chemistry</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Firearms/">Firearms</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/General/">General</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Health/">Health</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Java/">Java</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/JavaScript/">JavaScript</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Learning/">Learning</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Lifestyle/">Lifestyle</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Linguistics/">Linguistics</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Linux/">Linux</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Machine-Learning/">Machine Learning</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Mathematics/">Mathematics</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Meta/">Meta</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Pokemon/">Pokemon</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Psychology/">Psychology</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/PyCon/">PyCon</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Python/">Python</a><span class="tag-list-count">20</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/QA/">QA</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Recipes/">Recipes</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/SQL/">SQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Science/">Science</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Security/">Security</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Software-Development/">Software Development</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Startups/">Startups</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Travel/">Travel</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../tags/Tumblr/">Tumblr</a><span class="tag-list-count">4</span></li></ul>

  
    <article id="post-Good-code-should-look-magical" class="post">
	<footer class="entry-meta-header">
		<span class="meta-elements date">
			<a href="/2019/Good-code-should-look-magical/" class="article-date">
  <time datetime="2019-08-06T21:19:09.000Z" itemprop="datePublished">2019-08-06</time>
</a>
		</span>
		<span class="meta-elements author">Brian</span>
		<div class="commentscount">
			
		</div>
	</footer>
	
	<header class="entry-header">
		
  
    <h1 itemprop="name" class="entry-title">
      <a class="article-title" href="/2019/Good-code-should-look-magical/">Good Code Should Look Magical</a>
    </h1>
  

	</header>
	<div class="entry-content">
		
    	<p>You’ve written code before (if you haven’t, this is not interesting. Move along.) You’ve worked with other people’s code before, and have a vague memory of your experience when working with it. Maybe you remember working with your buddy Alex and found his code pleasant to work with, but had no idea why. Maybe you worked with your intern Ross and his code was terrible. But it all boils down to one thing:</p>
<p>Good code looks magical. It just does what it says it does. Intuitively, sensibly, and never fails.</p>
<p>If you can read a function’s name and instantly tell what it does, <em>and</em> that is actually what it does, then it may be good code. A real-world example would be No Name’s products. It does exactly what it says on the tin.</p>
<p>If a function takes a minimum number of parameters for the feature to work, then it may be good code. A real-world equivalent would be an online site that asks you for your email address, a new password, and nothing more.</p>
<p>If a function runs, and either a) it never fails, or b) you know exactly when it will fail, it may be good code. A real-world example would be a train that is always on time, except from 4am to 6am everyday, when there are no trains.</p>
<p>Good code doesn’t need you to know how it works. This is called encapsulation: you can’t see how it works. If you don’t know how it works, then <em>it just works</em>. Good code is like a mechanic that fixes your car when you tell them “it doesn’t work”; bad code is like a ticketing tooth that asks you to work the cashier, or know where the classroom is for a school.</p>
<p>Good code should be magical.</p>

    
	</div>
	<footer class="entry-footer">
		<div class="entry-meta-footer">
			<span class="category">
				
			</span>
			<span class="tags">
				
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../tags/Software-Development/">Software Development</a></li></ul>

			</span>
		</div>
	</footer>
	
</article>


	<hr class="article-devider">




  
    <article id="post-Things-Reddit-says-you-should-do-if-you-cant-sleep" class="post">
	<footer class="entry-meta-header">
		<span class="meta-elements date">
			<a href="/2019/Things-Reddit-says-you-should-do-if-you-cant-sleep/" class="article-date">
  <time datetime="2019-07-30T16:22:39.000Z" itemprop="datePublished">2019-07-30</time>
</a>
		</span>
		<span class="meta-elements author">Brian</span>
		<div class="commentscount">
			
		</div>
	</footer>
	
	<header class="entry-header">
		
  
    <h1 itemprop="name" class="entry-title">
      <a class="article-title" href="/2019/Things-Reddit-says-you-should-do-if-you-cant-sleep/">Things Reddit Says You Should Do if You Can&#39;t Sleep</a>
    </h1>
  

	</header>
	<div class="entry-content">
		
    	<p><a href="https://old.reddit.com/r/AskReddit/comments/cjo9sq/what_helps_you_go_to_sleep_when_you_dont_feel/" target="_blank" rel="external">From here</a></p>
<ol>
<li>Go read a book, no matter how fun you think it is.</li>
<li>Slowly count backwards from 99.</li>
<li>Play white noise.</li>
<li>Get up for a little bit, but don’t turn on any screens.</li>
<li>Play How It’s Made in the background.</li>
<li>Imagine being a character in a story (aka dreaming).</li>
<li>Focus on relaxing one specific body part, such as the feet.</li>
<li>Melatonin. Diphenhydramine. Various other things.</li>
</ol>

    
	</div>
	<footer class="entry-footer">
		<div class="entry-meta-footer">
			<span class="category">
				
			</span>
			<span class="tags">
				
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../tags/Health/">Health</a></li></ul>

			</span>
		</div>
	</footer>
	
</article>


	<hr class="article-devider">




  
    <article id="post-Odds-why-we-make-poor-decisions" class="post">
	<footer class="entry-meta-header">
		<span class="meta-elements date">
			<a href="/2019/Odds-why-we-make-poor-decisions/" class="article-date">
  <time datetime="2019-07-20T16:19:39.000Z" itemprop="datePublished">2019-07-20</time>
</a>
		</span>
		<span class="meta-elements author">Brian</span>
		<div class="commentscount">
			
		</div>
	</footer>
	
	<header class="entry-header">
		
  
    <h1 itemprop="name" class="entry-title">
      <a class="article-title" href="/2019/Odds-why-we-make-poor-decisions/">Odds: Why We Make Poor Decisions</a>
    </h1>
  

	</header>
	<div class="entry-content">
		
    	<p>Derived from the eponymous TED talk, <a href="https://www.youtube.com/watch?v=c-4flnuxNV4" target="_blank" rel="external">“Why we make bad decisions” by Dan Gilbert</a>.</p>
<h1 id="Intuition-is-your-enemy"><a href="#Intuition-is-your-enemy" class="headerlink" title="Intuition is your enemy"></a>Intuition is your enemy</h1><p>The easier you recall something, the more “intuitive” it is. The more intuitive something seems, the more correct we think it is.</p>
<p>You recall reading the news. Explosions, plane crashes, roadside bombings. Therefore, surely they are more dangerous than drowning in swimming pools. (Statistically, they are not.)</p>
<p>You recall watching lottery winners win. You rarely see people <em>lose</em> the lottery. Therefore, <em>bummed by intuition, you massively overestimate the odds of you winning</em>.</p>
<p><strong>Overcoming intuition</strong>: think only in terms of expectation value (see below). If the expectation value is positive, it’s a good bet/deal no matter what it is.</p>
<h1 id="Comparison-is-your-enemy"><a href="#Comparison-is-your-enemy" class="headerlink" title="Comparison is your enemy"></a>Comparison is your enemy</h1><p>You go to a grocery store to buy the bottle of wine that is neither the cheapest nor the most expensive. You go to a stereo shop and buy the best-sounding speakers there. Once you make the purchase and take it come, these are comparisons you will never make again. <em>Comparison changes the value of things.</em></p>
<p><strong>To overcome</strong>: don’t compare with other items. It doesn’t matter how much things are that are next to it.</p>
<h1 id="The-past-is-your-enemy"><a href="#The-past-is-your-enemy" class="headerlink" title="The past is your enemy"></a>The past is your enemy</h1><p>You would gladly book a trip that goes from \$2000 to \$1600 (a deal), but not one that goes from \$2000, on sale for \$700 (a steal), but \$1500 by the time you could book (a better deal than $1600). Why? Because you anchor the trip’s value on its past (\$700).</p>
<p><strong>To overcome</strong>: don’t compare a value of something with its past. The past value doesn’t matter at all; its current and future values are the only things that matter.</p>
<h1 id="The-present-is-your-enemy"><a href="#The-present-is-your-enemy" class="headerlink" title="The present is your enemy"></a>The present is your enemy</h1><p>\$60 now is better than \$50 now. (“More is better”)</p>
<p>But \$50 now is better than \$60 in a month. (“Now is better”)</p>
<p><em>But</em> \$60 in 13 months is better than \$50 in 12 months, even though the amount of additional time you wait is the same as the second example.</p>
<blockquote>
<p>Well, by and large people are enormously impatient. That is, they require interest rates in the hundred or thousands of percents in order to delay gratification and wait until next month for the extra 10 dollars.</p>
</blockquote>
<p><em>By comparing a potential future with the present, you underestimate the odds of your future pains, and overestimate the value of the present pleasures.</em> (Paraphrased from the TED talk)</p>
<p><strong>To overcome</strong>: your intuition is terrible. Do the maths, every time.</p>
<h1 id="The-golden-rule"><a href="#The-golden-rule" class="headerlink" title="The golden rule"></a>The golden rule</h1><p>$$<br>\operatorname{E}[X] =\sum_{i=1}^k x_i\,p_i=x_1p_1 + x_2p_2 + \cdots + x_kp_k.<br>$$</p>
<p>Expectation value = (odds of gain) * (value of gain).</p>

    
	</div>
	<footer class="entry-footer">
		<div class="entry-meta-footer">
			<span class="category">
				
			</span>
			<span class="tags">
				
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../tags/Psychology/">Psychology</a></li></ul>

			</span>
		</div>
	</footer>
	
</article>


	<hr class="article-devider">




  
    <article id="post-Roll-back-an-RDS-instance" class="post">
	<footer class="entry-meta-header">
		<span class="meta-elements date">
			<a href="/2019/Roll-back-an-RDS-instance/" class="article-date">
  <time datetime="2019-07-04T14:54:10.000Z" itemprop="datePublished">2019-07-04</time>
</a>
		</span>
		<span class="meta-elements author">Brian</span>
		<div class="commentscount">
			
		</div>
	</footer>
	
	<header class="entry-header">
		
  
    <h1 itemprop="name" class="entry-title">
      <a class="article-title" href="/2019/Roll-back-an-RDS-instance/">Roll Back an RDS Instance</a>
    </h1>
  

	</header>
	<div class="entry-content">
		
    	<p>Pre-requisites:</p>
<ul>
<li>An RDS instance snapshot</li>
<li>A stack that doesn’t connect directly to the instance endpoint (the thing that looks like <code>db-1.jhfksajdlhfl.us-east-1.rds.amazonaws.com</code>)</li>
</ul>
<p>I hope you have a snapshot. If you don’t, stop reading.</p>
<p>RDS will not let you simply roll back <code>db-1</code> to <code>db-1</code>, so you will have to restore your snapshot with another identifier, like <code>db-2</code>.</p>
<p>Note: when you restore a snapshot, none of the settings (instance type, security groups, parameter groups, option groups, what have you) are preserved. Make sure you set these up now, because setting up later will cause [more] downtime.</p>
<p>The identifier matters somewhat; you can change that later. More importantly is the endpoint URL (the thing that looks like <code>db-1.jhfksajdlhfl.us-east-1.rds.amazonaws.com</code>), which is also unique. If you hadn’t had the foresight to connect to the instance using a route53 CNAME instead of the raw one, also stop reading. </p>
<p>In my case, the stack is configured more convoluted (but thusly for good reason):</p>
<pre><code>Website (EC2) -&gt; 
    A/AAAA name (Route 53) to an elastic load balancer (ELB), for which
        -&gt; Port 5432 maps to a Target Group (TG) 
            -&gt; Containing a pgBouncer target (EC2), which connects to
                -&gt; A CNAME (Route 53) that maps to
                    -&gt; The RDS endpoint.
</code></pre><p>So switching the final CNAME from pointing to <code>db-1</code> to <code>db-2</code> will do.</p>
<p>During the RDS snapshot restore, <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Overview.DBInstance.Status.html" target="_blank" rel="external">you can start using the instance even when it’s in the “storage-optimization” state</a>.</p>

    
	</div>
	<footer class="entry-footer">
		<div class="entry-meta-footer">
			<span class="category">
				
			</span>
			<span class="tags">
				
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../tags/AWS/">AWS</a></li></ul>

			</span>
		</div>
	</footer>
	
</article>


	<hr class="article-devider">




  
    <article id="post-Late-game-Django-gotchas" class="post">
	<footer class="entry-meta-header">
		<span class="meta-elements date">
			<a href="/2019/Late-game-Django-gotchas/" class="article-date">
  <time datetime="2019-07-03T16:01:06.000Z" itemprop="datePublished">2019-07-03</time>
</a>
		</span>
		<span class="meta-elements author">Brian</span>
		<div class="commentscount">
			
		</div>
	</footer>
	
	<header class="entry-header">
		
  
    <h1 itemprop="name" class="entry-title">
      <a class="article-title" href="/2019/Late-game-Django-gotchas/">Late Game Django Gotchas</a>
    </h1>
  

	</header>
	<div class="entry-content">
		
    	<p>A guy named Kevin (not <a href="https://www.reddit.com/r/StoriesAboutKevin/" target="_blank" rel="external">that kind of Kevin</a>) once told me personal projects rarely reach the technical depth that your work projects do. And he’s right. I’ve been working on a Django project at work for five straight years, and I have never hit these problems in any of my personal projects.</p>
<h2 id="Your-database-is-not-limitless"><a href="#Your-database-is-not-limitless" class="headerlink" title="Your database is not limitless"></a>Your database is not limitless</h2><p><a href="https://www.honeybadger.io/blog/zero-downtime-migrations-of-large-databases-using-rails-postgres-and-redis/" target="_blank" rel="external">Assume every query returns a billion results</a>, because if you don’t, one day it will return a billion results. (In my case, every query returns a billion of what we call “legs”.)</p>
<p>If you don’t…</p>
<h2 id="Your-database-is-your-single-source-of-truth"><a href="#Your-database-is-your-single-source-of-truth" class="headerlink" title="Your database is your single source of truth"></a>Your database is your single source of truth</h2><p>Unless you are one of those forefront hipsters, you are likely going to <em>start</em> your web project as a monolith. But whether your project has a monolith, or a group of microservices that work together, there will always be a single source of truth: one or more databases, plus or minus shards, slaves, mirrors, what have you. (Let me know if it need not be the case.) If you write one bad query, the whole database server falls apart. And <strong>when the database server goes down, so does your service</strong>.</p>
<p>Solution: test your code. And not just unit test; <a href="https://en.wikipedia.org/wiki/Load_testing" target="_blank" rel="external">load test</a> it.</p>
<h2 id="Migrations-can-crash-servers"><a href="#Migrations-can-crash-servers" class="headerlink" title="Migrations can crash servers"></a>Migrations can crash servers</h2><p>(aka making your code handle both schemas)</p>
<p>Suppose you have version 1.0 of your code running <a href="https://en.wikipedia.org/wiki/Cloud_computing" target="_blank" rel="external">in the clouds</a>. 1.0 runs on database schema 1.0.</p>
<p>One day, you decide to write code (what a stupid idea) and publish website 2.0, with schema 2.0.</p>
<p>But you have a thousand concurrent users, and you have to figure out how to deploy your code without downtime. You draft up some ideas.</p>
<ul>
<li><strong>First deploy v2.0, then migrate database to v2.0</strong>: the project is broken from the time you all the v2 code is live, to the time the migration finishes.</li>
<li><strong>First migrate database to v2.0, and then deploy v2.0</strong>: assuming your schema <a href="https://github.com/tbicr/django-pg-zero-downtime-migrations#django-migrations-hacks" target="_blank" rel="external">doesn’t break anything</a>, it might just work. Except…</li>
</ul>
<h2 id="Migrations-are-atomic"><a href="#Migrations-are-atomic" class="headerlink" title="Migrations are atomic"></a>Migrations are atomic</h2><p>Migrations are atomic. This is the safe, intuitive default. If a migration fails, it simply didn’t happen. This is good.</p>
<p>But what if you have 100+ concurrent users, all of which must (for some reason) start a transaction on the table?</p>
<p>As it turns out, schema migrations, which run <a href="https://en.wikipedia.org/wiki/Data_definition_language" target="_blank" rel="external">DDL statements</a>, require an <a href="https://www.postgresql.org/docs/9.4/explicit-locking.html" target="_blank" rel="external"><code>ACCESS SHARE</code> lock or an <code>ACCESS EXCLUSIVE</code> lock</a> (depending on what you run), and if someone else (say, one of your loyal users) is holding a transaction on your table with <a href="https://www.postgresql.org/docs/9.4/explicit-locking.html" target="_blank" rel="external">a conflicting lock</a>, you cannot migrate on that same table.</p>
<pre><code>  File &quot;/root/site-packages/django/db/backends/utils.py&quot;, line 123, in execute
    return self.cursor.execute(sql, params)
psycopg2.extensions.TransactionRollbackError: deadlock detected
DETAIL:  Process 14524 waits for AccessExclusiveLock on relation 20621 of database 16403; blocked by process 12831.
Process 12831 waits for AccessShareLock on relation 20123 of database 16403; blocked by process 14524.
HINT:  See server log for query details.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File &quot;manage.py&quot;, line 123, in &lt;module&gt;
    execute_from_command_line(sys.argv)
  File &quot;/root/site-packages/django/core/management/__init__.py&quot;, line 123, in execute_from_command_line
    utility.execute()
  File &quot;/root/site-packages/django/core/management/__init__.py&quot;, line 123, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File &quot;/root/site-packages/django/core/management/base.py&quot;, line 123, in run_from_argv
    self.execute(*args, **cmd_options)
  File &quot;/root/site-packages/django/core/management/base.py&quot;, line 123, in execute
    output = self.handle(*args, **options)
  File &quot;/root/site-packages/django/core/management/commands/migrate.py&quot;, line 123, in handle
    fake_initial=fake_initial,
  File &quot;/root/site-packages/django/db/migrations/executor.py&quot;, line 123, in migrate
    state = self._migrate_all_backwards(plan, full_plan, fake=fake)
  File &quot;/root/site-packages/django/db/migrations/executor.py&quot;, line 123, in _migrate_all_backwards
    self.unapply_migration(states[migration], migration, fake=fake)
  File &quot;/root/site-packages/django/db/migrations/executor.py&quot;, line 123, in unapply_migration
    state = migration.unapply(state, schema_editor)
  File &quot;/root/site-packages/django/db/migrations/migration.py&quot;, line 123, in unapply
    operation.database_backwards(self.app_label, schema_editor, from_state, to_state)
  File &quot;/root/site-packages/django/db/migrations/operations/fields.py&quot;, line 123, in database_backwards
    self.database_forwards(app_label, schema_editor, from_state, to_state)
  File &quot;/root/site-packages/django/db/migrations/operations/fields.py&quot;, line 123, in database_forwards
    schema_editor.alter_field(from_model, from_field, to_field)
  File &quot;/root/site-packages/django/db/backends/base/schema.py&quot;, line 123, in alter_field
    return self._alter_many_to_many(model, old_field, new_field, strict)
  File &quot;/root/site-packages/django/db/backends/base/schema.py&quot;, line 123, in _alter_many_to_many
    new_field.remote_field.through._meta.get_field(new_field.m2m_field_name()),
  File &quot;/root/site-packages/django/db/backends/base/schema.py&quot;, line 123, in alter_field
    old_db_params, new_db_params, strict)
  File &quot;/root/site-packages/django/db/backends/postgresql/schema.py&quot;, line 123, in _alter_field
    new_db_params, strict,
  File &quot;/root/site-packages/django/db/backends/base/schema.py&quot;, line 123, in _alter_field
    self.execute(self._delete_constraint_sql(self.sql_delete_fk, model, fk_name))
  File &quot;/root/site-packages/django/db/backends/base/schema.py&quot;, line 123, in execute
    cursor.execute(sql, params)
  File &quot;/root/site-packages/django/db/backends/utils.py&quot;, line 123, in execute
    return self.cursor.execute(sql, params)
  File &quot;/root/site-packages/django/db/utils.py&quot;, line 123, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/root/site-packages/django/utils/six.py&quot;, line 123, in reraise
    raise value.with_traceback(tb)
  File &quot;/root/site-packages/django/db/backends/utils.py&quot;, line 123, in execute
    return self.cursor.execute(sql, params)
django.db.utils.OperationalError: deadlock detected
DETAIL:  Process 14524 waits for AccessExclusiveLock on relation 20621 of database 16403; blocked by process 12831.
Process 12831 waits for AccessShareLock on relation 20123 of database 16403; blocked by process 14524.
HINT:  See server log for query details.
</code></pre><p>The conflicting nature of the two operations also means that, should you try to migrate your schema anyway, and successfully obtain that <code>ACCESS SHARE</code> or <code>ACCESS EXCLUSIVE</code> lock it needed, then all of your loyal users will see database errors during the migration, which can take from minutes to hours (again, depending on what you are doing).</p>
<p><strong>Downtime. Not good.</strong></p>
<p>The solution is yet to be found. I hope to post a solution some day.</p>
<h2 id="Migrations-take-a-long-time"><a href="#Migrations-take-a-long-time" class="headerlink" title="Migrations take a long time"></a>Migrations take a long time</h2><p>Unlike your everyday hobby project, big projects have a tendency to live forever. And if you have a project that lives forever, the schema is bound to change. And if your schema changes, you need a migration. And if you add, god forbid, a <code>ForeignKey</code>… it is bound to run five DDL statements.</p>
<pre><code>1. BEGIN;  -- start the transaction
2. ALTER TABLE &quot;foo_bar&quot; ADD COLUMN &quot;baz&quot; ...;  -- adding a column is actually near-instant, so this is no biggie 
3. CREATE INDEX &quot;foo_bar_baz_123456&quot; ON &quot;foo_bar&quot; (&quot;baz&quot;);  -- creating an index... while locking writes (BAD)
4. ALTER TABLE &quot;foo_bar&quot; ADD CONSTRAINT &quot;foo_bar_baz_fk_qux_...&quot; FOREIGN KEY (&quot;baz&quot;) REFERENCES &quot;qux&quot; (&quot;quux&quot;) DEFERRABLE INITIALLY DEFERRED;  -- this makes the column a foriegn key.
5. COMMIT;
</code></pre><p>Guess what, if you have a billion rows in your database, step 3 and 4 going to take <em>forever</em>. And you don’t have forever. You have 5 seconds. So you need to do something else.</p>
<p>Possible solutions to try:</p>
<ul>
<li><strong>Setting <code>db_index=False</code> to omit step 3 from the migration</strong>: I mean, sure, but step 4 (which checks if the existing values are valid) will take just as long.</li>
<li><strong>Creating those fields ahead of time outside the Django framework</strong>: That’s a lot of work Django’s been doing for you for free!</li>
<li><strong><a href="https://docs.djangoproject.com/en/2.2/ref/migration-operations/#separatedatabaseandstate" target="_blank" rel="external"><code>SeparateDatabaseAndState</code></a></strong>: By running any query you want while keeping state automatic, you trick Django into believing it ran the queries it thinks it should. Novel? Yes. Useful? Also yes. But the migrations will take just as long.</li>
<li><strong>Fuck migrations, do your own thing</strong>: Not bad of an idea if you have enough manpower to deal with migrations. By building a tool that replaces django’s built-in migrations, you can definitely achieve zero-downtime, minimal-lock, free-form schema changes. But at what cost?</li>
</ul>
<h2 id="For-a-table-a-3ms-query-really-isn’t-good-enough"><a href="#For-a-table-a-3ms-query-really-isn’t-good-enough" class="headerlink" title="For a table, a 3ms query really isn’t good enough"></a>For a table, a 3ms query really isn’t good enough</h2><p>So say you have a table that has a billion rows, and you have to add a column to the table. It is near-instantaneous.</p>
<p>However, should you need to <em>populate the column with data</em>, it becomes a whole new <del>world</del>estimate.</p>
<p>Say you have a <a href="https://en.wikipedia.org/wiki/Denormalization" target="_blank" rel="external">denormalisation</a> query to run, that reduces joins to speed up queries, but at the expense of storing extraneous information in that extra column; a lookup for each row costs 3ms. What is the cost to update the entire table?</p>
<p>$$<br>0.003s * 1000000000 / 86400 =  35<br>$$</p>
<p>Solution: no solution. Think long and hard about <a href="/2019/Slow-queries-what-to-do/">table partitioning</a>.</p>
<h2 id="Related-names-seemingly-out-of-nowhere"><a href="#Related-names-seemingly-out-of-nowhere" class="headerlink" title="Related names seemingly out of nowhere"></a>Related names seemingly out of nowhere</h2><p>Imagine you have a <code>Model</code> with a <code>ForeignKey</code> that has a related name:</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">Foo</span>(<span class="type">Model</span>):</span></span><br><span class="line"><span class="class">    bar = <span class="type">ForeignKey</span>(<span class="type">Bar</span>, <span class="title">related_name</span>='<span class="title">foos'</span>)</span></span><br></pre></td></tr></table></figure>
<p>Then, whenever you have a <code>Bar</code>, you can easily access its <code>foos</code>.</p>
<p>Now imagine you have a hundred or so foreign keys that point back to <code>Foo</code>.</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class Foo(Model):</span><br><span class="line">    bar = ForeignKey(Bar, <span class="attribute">related_name</span>=<span class="string">'foos'</span>)</span><br><span class="line">    baz = ForeignKey(Baz, <span class="attribute">related_name</span>=<span class="string">'foos'</span>)</span><br><span class="line">    qux = ForeignKey(Qux, <span class="attribute">related_name</span>=<span class="string">'foos'</span>)</span><br><span class="line">    quux = ForeignKey(Quux, <span class="attribute">related_name</span>=<span class="string">'foos'</span>)</span><br></pre></td></tr></table></figure>
<p>In the code, whenever you see <code>.foos.all()</code>, you can tell for sure that it gives you instances of <code>Foo</code>, right?</p>
<p>But what if you have an <code>app_1.Foo</code> <em>and</em> an <code>app_2.Foo</code>?</p>
<p>Please don’t do that.</p>
<h2 id="Removing-a-field-with-no-downtime-is-a-nightmare"><a href="#Removing-a-field-with-no-downtime-is-a-nightmare" class="headerlink" title="Removing a field with no downtime is a nightmare"></a>Removing a field with no downtime is a nightmare</h2><p>Let’s say you have a model with two fields.</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">Foo</span>(<span class="type">Model</span>):</span></span><br><span class="line"><span class="class">    bar = <span class="type">BooleanField</span>()</span></span><br><span class="line"><span class="class">    baz = <span class="type">BooleanField</span>()</span></span><br></pre></td></tr></table></figure>
<p>and you want to remove one of the fields with on downtime. As it turns out, the moment you deploy a (new) change that removes the field, the existing (old) deployment will sense that the field has been removed, and 500 on you until they are scaled down. <em>This is downtime.</em></p>
<p>To remove a field, this field must go through multiple phases of deprecation.</p>
<ol>
<li><strong>Ensure the field is nullable</strong>.</li>
<li><strong>Remove all code that uses the field.</strong> Deploy this change. Now none of your code touches this field.</li>
<li>But wait… Django’s ORM will still go and look for that field whenever it makes a query. You know what makes these queries anyway? The Django admin. You need to do this in two phases. First, <strong>make a <code>SeparateDatabaseAndState</code> migration that only “deletes” the field from the ORM.</strong> Deploy this change. Now none of your code really touches this field.</li>
<li>Then, <strong>make a <code>SeparateDatabaseAndState</code> migration that only deletes the column from the table</strong>, i.e. the second half of the migration above. Now you have no code running that touches the field, and no column in the table.</li>
</ol>
<h2 id="Adding-a-PositiveIntegerField-freezes-migrations"><a href="#Adding-a-PositiveIntegerField-freezes-migrations" class="headerlink" title="Adding a PositiveIntegerField freezes migrations"></a>Adding a <code>PositiveIntegerField</code> freezes migrations</h2><p>Note that <code>PositiveIntegerField</code> does the following:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">"foo_bar"</span> <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> <span class="string">"baz"</span> <span class="built_in">integer</span> <span class="literal">NULL</span> <span class="keyword">CHECK</span> (<span class="string">"baz"</span> &gt;= <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>Even if you had just created that column <code>baz</code>, postgres <a href="https://www.postgresql.org/docs/10/sql-altertable.html" target="_blank" rel="external">will</a>, however stupid it may seem, scan the entire table to make sure the constraint is valid for all your rows.</p>
<p>If you have a billion rows in that table, your deployment will time out and fail.</p>

    
	</div>
	<footer class="entry-footer">
		<div class="entry-meta-footer">
			<span class="category">
				
			</span>
			<span class="tags">
				
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../tags/Python/">Python</a></li></ul>

			</span>
		</div>
	</footer>
	
</article>


	<hr class="article-devider">




  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="../../">&laquo; Prev</a><a class="page-number" href="../../">1</a><span class="page-number current">2</span><a class="page-number" href="../3/">3</a><a class="page-number" href="../4/">4</a><span class="space">&hellip;</span><a class="page-number" href="../25/">25</a><a class="extend next" rel="next" href="../3/">Next &raquo;</a>
    </nav>
  


    </div>
    <div class="mb-search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:blog.ohai.ca">
  </form>
</div>
<footer id="footer">
	<h1 class="footer-blog-title">
		<a href="/">Brian&#39;s Blog</a>
	</h1>
	<span class="copyright">
		&copy; 2019 Brian<br>
		Modify from <a href="http://sanographix.github.io/tumblr/apollo/" target="_blank">Apollo</a> theme, designed by <a href="http://www.sanographix.net/" target="_blank">SANOGRAPHIX.NET</a><br>
		Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
	</span>
</footer>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>



<script src="../../../js/script.js"></script>
  </div>

  <script type="text/javascript">
    //<![CDATA[
    var sc_project=4446854;
    var sc_invisible=0;
    var sc_security="74785e80";
    var scJsHost = (("https:" == document.location.protocol) ?
    "https://secure." : "http://www.");
    document.write(
      "<sc"+"ript type='text/javascript' src='" +
      scJsHost +
      "statcounter.com/counter/counter_xhtml.js'></" +
      "script>"
    );
    //]]>
  </script>
  <noscript>
    <img style="display: none"
         src="http://c.statcounter.com/4446854/0/74785e80/0/" />
  </noscript><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>
